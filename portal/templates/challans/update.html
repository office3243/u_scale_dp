{% extends "portal/base.html" %}
{% load crispy_forms_tags %}

{% block title %}Create Challan{% endblock %}

{% block content %}

    <div class="jumbotron container">
{#            {{ form|crispy }}#}

            <h3 class="text-black-50 font-weight-bold text-center">Create Challan</h3>

            <label class="font-weight-bold">Party Code : </label>
            <span class="font-weight-bold text-primary">{{ challan.party.get_display_text }}</span>
            <br>
            <label class="font-weight-bold">Challan No : </label>
            <span class="font-weight-bold text-primary">{{ challan.challan_no }}</span>
            <br>
            <label class="font-weight-bold">Challan Total : </label>
            <span class="font-weight-bold text-primary">{{ challan.weights_amount }}</span>

            <div class="container text-center pick_material jumbotron">
                <label class="text-black-50 font-weight-bold">Pick Material</label>
                <div class="row">
                    {% for material in materials %}

                        <button class="btn btn-lg btn-primary   mt-selector" id="material_btn_{{ material.id }}" material_id="{{ material.id }}">{{ material.get_display_text }}</button>
{#                        <a style="margin: 10px" id="material_btn_{{ material.id }}" class="card bg-primary col-lg-2 mt-selector" material_id="{{ material.id }}">{{ material.get_display_text }}</a>#}
                    {% endfor %}
                </div>
            </div>
            <hr>
            <div class="container text-center jumbotron">

                <label class="font-weight-bold text-black-50" for="current_material">Current Material</label><br>
                <button class="btn btn-primary btn-lg" id="current_material" material_id="{{ materials.first.id }}">{{ materials.first.get_display_text }}</button>

                <form method="post" action="{% url "challans:weight_entry_create" %}">
                    {% csrf_token %}
                    <input name="challan_no" value="{{ challan.challan_no }}" hidden>
                    <br>
                    <input id="material_input" name="material_id" hidden>
                    <br>
                    <div class="row text-center">
                        <div class="form-group col-lg-6" style="margin: auto">
                            <label for="weight_input" class="font-left font-weight-bold text-black-50">Enter Weight</label>
                            <input id="weight_input" class="form-control float-right" name="entry_weight" material_id="{{ materials.first.id }}">
                        </div>
                    </div>
                    <br><br>
                    <button type="submit" class="btn btn-primary">Save</button>
                </form>
            </div>


            <table class="table table-striped table-info table-bordered" id="thetable">
                <tbody>
                    {% for weight in challan.weight_set.all %}
                        <tr>
                            <td>{{ weight.material.code }}</td>
                            {% for weight_entry in weight.weightentry_set.all %}
                                <td>{{ weight_entry.entry }}</td>
                            {% endfor %}
                            <td>Total = {{ weight.total_weight }}</td>
                            <td>Rate = {{ weight.rate_per_unit }}</td>
                            <td>Amount = {{ weight.amount }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        <a href="{% url "challans:preview_update" challan_no=challan.challan_no %}"><button class="btn btn-primary btn-block">Preview</button></a>
    </div>


    <script type="text/javascript">

        $(function() {
    var t = $('#thetable tbody').eq(0);
    var r = t.find('tr');
    var cols= r.length;
    var rows= r.eq(0).find('td').length;
    var cell, next, tem, i = 0;
    var tb= $('<tbody></tbody>');

    while(i<rows){
        cell= 0;
        tem= $('<tr></tr>');
        while(cell<cols){
            next= r.eq(cell++).find('td').eq(0);
            tem.append(next);
        }
        tb.append(tem);
        ++i;
    }
    $('#thetable').append(tb);
    $('#thetable').show();
});


        let weightedMaterials = {};

        $(".mt-selector").on("click", function () {
            $("#current_material").attr("material_id", $(this).attr("material_id"));
            $("#current_material").text($(this).text());
            $("#material_input").val($(this).attr("material_id"))

        });

    var url_string = window.location.href;
    var url = new URL(url_string);
    var lmtid = url.searchParams.get("lmtid");
    console.log(lmtid);
    $("#material_input").val(lmtid);
    $("#material_btn_" + lmtid)[0].click().attr("id");

    </script>



{% endblock %}