{% extends "portal/base.html" %}
{% load crispy_forms_tags %}

{% block title %}Add Weight Entries{% endblock %}

{% block custom_links %}
    <style>
        td{
          {#font-weight: bold!important;#}
        }
       #tb td{
           max-width: 80px;
       }
       #tb th{
            max-width: 90px;
            background-color: #4285f4;
            font-weight: bold;
            color: white;
       }
       .tableMaterialHead{
           background-color: #4285f4;
           color: white;
           font-weight: bold;
       }
    </style>
{% endblock %}

{% block content %}

    <div class="container" style="padding: 50px 20px">

        <div class="heading" id="heading">
            <h3 class="text-black-50 font-weight-bold text-center">Add Entries | Step 1</h3>
            <hr>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="row">
                    <div class="col-lg-6">
                        <h3 class="float-left m-auto">Challan Details</h3>
                    </div>
                    <div class="col-lg-6">
                        <i class="fa fa-eye-slash mt-2 float-right" id="challan_details_toggle"></i>
                    </div>
                </div>
            </div>
            <div class="card-body" id="challanDetails">
                <table class="table">
                    <tbody>
                        <tr>
                            <th>Party Code</th>
                            <td>{{ challan.party.get_display_text }}</td>
                            <th>Challan No</th>
                            <td>{{ challan.challan_no }}</td>
                        </tr>
                        <tr>
                            <th>Date</th>
                            <td>{{ challan.created_on.date }}</td>
                            <th>Time</th>
                            <td>{{ challan.created_on.time }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <br><hr>
        <div class="text-center">
            <div class="row">
                <div id="pickMaterial" class="col-lg-6">
                    <label class="text-black-50 font-weight-bold">Pick Material</label>
                    <div class="row">
                        {% for material in materials %}
                            <button class="btn btn-lg btn-primary mt-selector" id="material_btn_{{ material.id }}" material_id="{{ material.id }}">{{ material.get_display_text }}</button>
                        {% endfor %}
                    </div>
                </div>
                <div id="weightForm" class="col-lg-6">
                <label class="font-weight-bold text-black-50" for="current_material">Current Material</label><br>
                <button class="btn btn-primary btn-lg" id="current_material" material_id="">-</button>

                <br><br><hr>
                <form method="post" action="{% url "challans:weight_entry_create" %}">
                    {% csrf_token %}
                    <input name="challan_no" value="{{ challan.challan_no }}" hidden>
                    <input id="material_input" name="material_id" hidden required>
                    <div class="row col-lg-10" style="margin: auto">
                        <div class="float-left col-lg-8 mt-2">
                            <div class="form-group">
                                <input id="weight_input" class="weight_entry_input form-control" name="entry_weight" material_id="{{ materials.first.id }}" placeholder="Enter Weight">
                            </div>
                        </div>
                        <div class="float-right col-lg-4 mb-5">
                            <button type="submit" class="btn btn-primary btn-lg">Save</button>
                        </div>
                    </div>

                </form>
                <span class="font-weight-bold alert-primary alert">
                    Last Weight Entry :
                    {% with challan.get_recent_weight_entry as recent_entry%}
                        {{ recent_entry.weight.material }} - {{ recent_entry.entry }}
                    {% endwith %}
                </span>

            </div>
            </div>
        </div>
        <hr>
        {% if challan.weight_set.exists %}
            <div class="entries" style="margin-top:50px">
                <h3 class="text-center text-black-50 font-weight-bold">Weight Entries</h3>
                <div class="table-responsive  text-nowrap">
                    <table class="table table-bordered table-hover">
                        <tbody id="tb">
                        </tbody>
                    </table>
                </div>
            </div>
            <hr>

            <div class="card">
                <div class="card-header">
                    <h3 class="m-auto">Submit Entries</h3>
                </div>
                <div class="card-body">
                    <form method="post" {{ challan.get_submit_entries_url }}>
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="has_report_weight">Challan Reports</label>
                            <select class="form-control" id="has_report_weight">
                                <option value="N">No</option>
                                <option value="Y">Yes</option>
                            </select>
                            <hr>
                            <div id="report_materials" class="form-group">

                            </div>
                        </div>
                        <button class="btn btn-primary" type="submit">Submit</button>
                    </form>
                </div>
            </div>
        {% endif %}
    </div>
        <table id='tb' class="table table-bordered">
            <tr>
                <td>M1</td>
                <td>1</td>
                <td>2</td>
                <td>3</td>
                <td>4</td>
                <td>5</td>
                <td>6</td>
                <td attr='rate'>R1</td>
                <td attr='total'>T1</td>
                <td attr='amount'>A1</td>
            </tr>
            <tr>
                <td>M2</td>
                <td>a</td>
                <td>b</td>
                <td>c</td>
                <td>d</td>
                <td attr='rate'>R2</td>
                <td attr='total'>T2</td>
                <td attr='amount'>A2</td>
            </tr>
            <tr>
                <td>M3</td>
                <td>A</td>
                <td attr='rate'>R3</td>
                <td attr='total'>T3</td>
                <td attr='amount'>A3</td>
            </tr>
        </table>
        <table id="newTB" class="table table-bordered">

        </table>
{% endblock %}
{% block custom_script %}

    <script>

        $("#challan_details_toggle").on("click", function () {
            $("#challanDetails").toggle();
            $(this).toggleClass("fa-eye fa-eye-slash");
        });

        function makeFocused(element){
            element.setAttribute("is_focused", "true");
        }

        $(".tempInput").on("change", function () {
            let targetInput = document.getElementById($(this).attr("target_id"));
            targetInput.value = $(this).val();
            $("#tempAmount_" + $(this).attr("formset_order")).text((parseFloat($(this).val()) * parseFloat($("#tempWeight_" + $(this).attr("formset_order")).text())).toFixed(2));
        });

        $("#formsetSubmitBtn").on("click", function () {
            let form_invalid = false;
            $("tempInput").each(function () {
                    if ($(this).attr("is_focused") === "false"){
                        form_invalid = true;
                    }

            });
            if (!form_invalid){
                $("#formset").submit();
            }
            else {
                alert("Assign rates first");
            }
        });


        $(".mt-selector").on("click", function () {
            let current_material = $("#current_material");
            current_material.attr("material_id", $(this).attr("material_id"));
            current_material.text($(this).text());
            $("#material_input").val($(this).attr("material_id"))

        });


        function assignEntriesTable() {
        console.log(555);
        let max_length=1,max_row,cnt=0;
        const Table = document.getElementById('tb');
        for(let i = 0; i < Table.rows.length; i++){
            if(max_length < Table.rows.item(i).cells.length){
                max_row = i;
                max_length = Table.rows.item(i).cells.length;
            }
        }
        for(let j=0; j < max_length; j++){
            if(Table.rows.item(max_row).cells[j].hasAttribute('attr'))
                cnt++;
        }
        for(let j=0; j < max_length-cnt; j++){
            let tr=document.createElement("tr");
            for(let i=0;i < Table.rows.length;i++){
                let td = document.createElement("td");
                let txt;
                if(j< Table.rows.item(i).cells.length-cnt){
                    txt= document.createTextNode(Table.rows.item(i).cells[j].innerHTML);
                }else{
                    txt = document.createTextNode("");
                }
                td.appendChild(txt);
                tr.appendChild(td);
            }
            document.querySelector('#newTB').appendChild(tr);
        }
        for(let k=0; k < cnt; k++){
            let attrValue;
            let tr=document.createElement("tr");
            for(let i=0;i < Table.rows.length;i++){
                let td = document.createElement("td");
                let txt;
                let j = (Table.rows.item(i).cells.length)+k-cnt;
                txt = document.createTextNode(Table.rows.item(i).cells[j].innerHTML);
                td.appendChild(txt);
                tr.appendChild(td);
            }
            document.querySelector('#newTB').appendChild(tr);
        }
        }

        function assignLMT() {
            let url_string = window.location.href;
            let url = new URL(url_string);
            let lmtid = url.searchParams.get("lmtid");
            if (lmtid){
                $("#material_input").val(lmtid);
                $("#material_btn_" + lmtid)[0].click();
            }

        }

        // Onlaod All Functions to be called from here
        $(function () {
            assignLMT();
            {% if challan.weight_set.exists %}
                assignEntriesTable();
            {% endif %}

        });

        </script>

{% endblock %}

