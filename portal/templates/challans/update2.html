{% extends "portal/base.html" %}
{% load crispy_forms_tags %}

{% block title %}Create Challan{% endblock %}

{% block content %}

    <div class="jumbotron container">
{#            {{ form|crispy }}#}

            <h3 class="text-black-50 font-weight-bold text-center">Create Challan</h3>

            <label class="font-weight-bold">Party Code : </label>
            <span class="font-weight-bold text-primary">{{ challan.party.get_display_text }}</span>
            <br>
            <label class="font-weight-bold">Challan No : </label>
            <span class="font-weight-bold text-primary">{{ challan.challan_no }}</span>
            <br>
            <label class="font-weight-bold">Challan Total : </label>
            <span class="font-weight-bold text-primary">{{ challan.weights_amount }}</span>

            <div class="container text-center pick_material jumbotron">
                <label class="text-black-50 font-weight-bold">Pick Material</label>
                <div class="row">
                    {% for material in materials %}

                        <button class="btn btn-lg btn-primary   mt-selector" id="material_btn_{{ material.id }}" material_id="{{ material.id }}">{{ material.get_display_text }}</button>
{#                        <a style="margin: 10px" id="material_btn_{{ material.id }}" class="card bg-primary col-lg-2 mt-selector" material_id="{{ material.id }}">{{ material.get_display_text }}</a>#}
                    {% endfor %}
                </div>
            </div>
            <hr>
            <div class="container text-center jumbotron">

                <label class="font-weight-bold text-black-50" for="current_material">Current Material</label><br>
                <button class="btn btn-primary btn-lg" id="current_material" material_id="{{ materials.first.id }}">{{ materials.first.get_display_text }}</button>

                <form method="post" action="{% url "challans:weight_entry_create" %}">
                    {% csrf_token %}
                    <input name="challan_no" value="{{ challan.challan_no }}" hidden>
                    <br>
                    <input id="material_input" name="material_id" hidden>
                    <br>
                    <div class="row text-center">
                        <div class="form-group col-lg-6" style="margin: auto">
                            <label for="weight_input" class="font-left font-weight-bold text-black-50">Enter Weight</label>
                            <input id="weight_input" class="form-control float-right" name="entry_weight" material_id="{{ materials.first.id }}">
                        </div>
                    </div>
                    <br><br>
                    <button type="submit" class="btn btn-primary">Save</button>
                </form>
            </div>


            <table class="table table-striped table-info table-bordered" id="thetable">
                <tbody>
                    {% for weight in challan.weight_set.all %}
                        <tr>
                            <td>{{ weight.material.code }}</td>
                            {% for weight_entry in weight.weightentry_set.all %}
                                <td>{{ weight_entry.entry }}</td>
                            {% endfor %}
                            <td>Total = {{ weight.total_weight }}</td>
                            <td>Rate = {{ weight.rate_per_unit }}</td>
                            <td>Amount = {{ weight.amount }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        <a href="{% url "challans:preview_update" challan_no=challan.challan_no %}"><button class="btn btn-primary btn-block">Preview</button></a>
    </div>


    <script type="text/javascript">

        $(function() {
    var t = $('#thetable tbody').eq(0);
    var r = t.find('tr');
    var cols= r.length;
    var rows= r.eq(0).find('td').length;
    var cell, next, tem, i = 0;
    var tb= $('<tbody></tbody>');

    while(i<rows){
        cell= 0;
        tem= $('<tr></tr>');
        while(cell<cols){
            next= r.eq(cell++).find('td').eq(0);
            tem.append(next);
        }
        tb.append(tem);
        ++i;
    }
    $('#thetable').append(tb);
    $('#thetable').show();
});


        let weightedMaterials = {};

        $(".mt-selector").on("click", function () {
            $("#current_material").attr("material_id", $(this).attr("material_id"));
            $("#current_material").text($(this).text());
            $("#material_input").val($(this).attr("material_id"))

        });

    var url_string = window.location.href;
    var url = new URL(url_string);
    var lmtid = url.searchParams.get("lmtid");
    console.log(lmtid);
    $("#material_input").val(lmtid);
    $("#material_btn_" + lmtid)[0].click();

    </script>



{% endblock %}



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <link href="css/mdb.min.css" rel="stylesheet">
   <style>
       #tb td{
           max-width: 40px;
       }
   </style>
</head>
<body>
    <div class="container" style="margin-top:50px">
            <div class="table-responsive  text-nowrap">
        <table class="table table-bordered table-hover">
            <tbody  id="tb">
            </tbody>
        </table>
        </div>
    </div>
    <script>
            let a = [
                [1,2,3,4,5,"rate","total","amo"],
                ["a","b","c","rate","total","amo"],
                ["A","B","rate","total","amo"],
                [1,2,3,4,5,6,7,8,"rate","total","amo"],
                [1,2,3,4,5,"rate","total","amo"],
                ["a","b","c","rate","total","amo"],
                ["A","B","rate","total","amo"],
                [1,2,3,4,5,6,7,8,"rate","total","amo"],
                [1,2,3,4,5,"rate","total","amo"],
                ["a","b","c","rate","total","amo"],
                ["A","B","rate","total","amo"],
                [1,2,3,4,5,6,7,8,"rate","total","amo"],
                [1,2,3,4,5,"rate","total","amo"],
                ["a","b","c","rate","total","amo"],
                ["A","B","rate","total","amo"],
            ];
            $(function () {
                let k=0;
                for(let i=1;i<a.length;i++)
                {
                    if(a[k].length < a[i].length)
                    {
                        k = i;
                    }
                }
                for(let j=0,l=3;j<a[k].length;j++){
                   let tr=document.createElement("tr");
                   if(j<a[k].length-3){
                        for(let i=0;i<a.length;i++){
                            let td = document.createElement("td");
                            let txt;
                            if(j< a[i].length-3){
                                txt= document.createTextNode(a[i][j]);
                            }else{
                                txt = document.createTextNode("");
                            }
                            td.appendChild(txt);
                            tr.appendChild(td);
                        }
                    }else{
                        for(let i=0;i<a.length;i++){
                            let len = a[i].length;
                            let td = document.createElement("td");
                            let txt = document.createTextNode(a[i][len-l]);
                            td.appendChild(txt);
                            tr.appendChild(td);
                        }
                        l--
                    }
                   document.querySelector('#tb').appendChild(tr);
                }
            })

        </script>



</body>
</html>